[{"title":"report ofTrojan.Android.KRBanker.md","timestamp":1544300365684,"body":{"black_white":0,"filetype":"exe_32bit","first_seen":"2018-11-12 00:38:38","ai_score":100,"view_count":0,"result_msg":"Data exists","file_info":{},"filename":"","version":"2015072100","filesize":3514368,"sha256":"955BC4869DAAF43546FE9A91AA1CD50A0D6268F8460E93ABA2C23E19D034DB6E","taglist":["peexe","exe_32bit"],"string":{"pdb":""},"imphash":"68F013D7437AA653A8A98A05807AFEB1","distribute_url":[],"date":"2018-11-13 08:57:27","ssdeep":"49152:nQqMSPbcBVQej/N9PAMEcAEaQR8yAH1plAHj:QqPoBhzN9P5DR8yAVp2Hj","adversary":{},"md5":"D4E0E0EECECCBFC7FD76A16D76FB064A","sha1":"B99AC8C67262A2B638302FB6C48FD2ED69E58AC1","signcheck":{"verified":"Unsigned"},"tag_name_etc":[{"tag":"trojan","type":2},{"tag":"wannacryptor","type":2},{"tag":"ransomware","type":2},{"tag":"wannacry","type":2},{"tag":"wannacrypt","type":2},{"tag":"wanna","type":2},{"tag":"wcry","type":2}],"behavior":{"result":"analyzing"},"similar_to_file":[],"result_code":1,"analyzer":"5dvW5oJp1uS7pH5iJbQmy2LEz4ZS5YbMZuTYwGPeSynrRQNpgs","collector":"6zzCNmV89RCbY17uc7npxb4HvKsPP2CSTCVHiDqoE5vmrmaxCi","description":"**Trojan.Android.KRBanker**\r\n\r\n  \r\n\r\n스미싱과 보이스피싱 등을 결합한 형태로 악성 앱들이 유포되고 있습니다. 해당 앱들은 주로 1 금융 관련 앱을 사칭하였으나 최근에는 국가기관, 금융 사칭 등으로 다양한 형태로 나타나고 있습니다. 기기 및 개인정보를 탈취하고 금융 정보 탈취를 목적으로 기기의 통화 상태를 감시합니다.\r\n\r\n  \r\n\r\n특히, 해당 앱은 분석을 어렵게 하기 위해서 중국 Qihoo 360사의 패킹 기술을 적용하였습니다.\r\n\r\n   \r\n\r\n본 분석 보고서에서는 “Trojan.Android.KRBanker”를 상세 분석하고자 합니다.\r\n\r\n  \r\n\r\n**악성코드 상세 분석**\r\n\r\n  \r\n\r\n\\1. 패킹 특징  \r\n\r\n  \r\n\r\n중국 Qihoo 360사의 패킹 된 앱은 일반 앱과는 다른 부분이 존재합니다. 앱의 권한과 컴포넌트 관련 정보를 볼 수 있는 매니페스트를 보면 일반 안드로이드 앱에서는 볼 수 없는 항목인 “android:qihoo”부분이 추가되어 있는데 이는 디컴파일을 방해합니다. “assets” 폴더에는 파일의 무결성과 동적 패킹에 관여하는 “.appkey”, “libjiagu.so” 파일이 포함되어 있습니다. 또한, 아래 [그림 2]를 보면 패키지명이 “com.android.hellod3”이지만, 패킹 된 덱스 코드에서는 해당 부분을 찾을 수 없어 정적 분석으로는 실제 악성 행위와 관련된 코드를 볼 수 없습니다.\r\n\r\n  \r\n\r\n![](https://t1.daumcdn.net/cfile/tistory/99C66C3E5BF4F19015)\r\n\r\n![](https://t1.daumcdn.net/cfile/tistory/9986B84B5BF4F19009)\r\n\r\n​\t\t\t\t\t\t\t\t\t[그림 1] 패킹 된 앱의 구조\r\n\r\n![](https://t1.daumcdn.net/cfile/tistory/99264D355BF4F27D26)\r\n\r\n​\t\t\t\t\t\t\t\t\t[그림 2] 패킹 전 후 덱스코드 비교\r\n\r\n  \r\n\r\n\\2. 안티 디컴파일러\r\n\r\n  \r\n\r\n앱 디컴파일에 흔히 쓰이는 “apktool” 최신 버전을 통해서 컴파일을 시도하면 매니페스트의 “qihoo”와 관련된 요소를 찾을 수 없다고 하여 에러를 일으킨다. 앱의 동적 분석을 위해서는 매니페스트에 android:debuggable=\"true\" 항목이 필요한데 이를 방지한다.\r\n\r\n![](https://t1.daumcdn.net/cfile/tistory/995692355BF4F19008)\r\n\r\n​\t\t\t\t\t\t\t\t\t\t[그림 3] 컴파일 실패\r\n\r\n\r\n\r\n\\3. 안티 디버깅\r\n\r\n  \r\n\r\n패킹 앱의 초기에는 안티 디버깅이 포함되어 있지 않아서 메모리에 로드된 덱스 파일을 실시간 덤프를 함으로써 간단히 패킹앱의 분석이 가능했습니다. 그러나 최근 패킹 앱에는 다양한 안티 디버깅 기법이 추가되었기 때문에 동적 분석을 통해서 안티 디버깅을 우회한 다음에서야 메모리에 로드된 덱스 파일 덤프가 가능합니다.\r\n\r\n  \r\n\r\n3.1 dlactivity 확인\r\n\r\n“/system/linker” 모듈 내부에 존재하는 “dl_rtld_db_dlactivity”의 값은 디버깅 되고 있는지 없는지를 나타냅니다.\r\n\r\n![](https://t1.daumcdn.net/cfile/tistory/994E27335BF4F19019)\r\n\r\n​\t\t\t\t\t\t\t\t[그림 4] dlactivity 활용 안티 디버깅\r\n\r\n  \r\n\r\n3.2 TracerPid 확인\r\n\r\n“/proc/self/status” 파일을 확인해보면 앱과 관련된 정보들이 나타나있습니다. 그 중에서 “TracerPid”의 값을 통해서 디버깅 여부를 확인할 수 있습니다.\r\n\r\n![](https://t1.daumcdn.net/cfile/tistory/99E9DB3A5BF4F19018)\r\n\r\n​\t\t\t\t\t\t\t\t\t\t ![](https://t1.daumcdn.net/cfile/tistory/993AB4385BF4F19018)\r\n\r\n![](https://t1.daumcdn.net/cfile/tistory/99E207425BF4F19014)\r\n\r\n​\t\t\t\t\t\t\t\t[그림 5] TracerPid 활용 안티 디버깅\r\n\r\n  \r\n\r\n3.3 주소 활성화 여부 확인\r\n\r\n주소와 포트를 확인하여 디버깅 여부를 확인합니다. IDA를 통해서 안드로이드 원격 디버깅이 가능한데, IDA의 기본 디버깅 주소와 포트의 활성화 여부를 확인하여 디버깅 여부를 확인합니다.\r\n\r\n​\t\t\t\t\t\t\t\t\t\t ![](https://t1.daumcdn.net/cfile/tistory/99A744405BF4F19001)\r\n\r\n​\t\t\t\t\t\t\t\t\t\t\t![](https://t1.daumcdn.net/cfile/tistory/9982743A5BF4F1901C)\r\n\r\n![](https://t1.daumcdn.net/cfile/tistory/99E4AB4E5BF4F1900D)\r\n\r\n![](https://t1.daumcdn.net/cfile/tistory/9901853A5BF4F19022)\r\n\r\n​\t\t\t\t\t\t\t\t\t[그림 6] 주소 확인을 통한 안티 디버깅\r\n\r\n  \r\n\r\n  \r\n\r\n3.4 특정 문자 확인\r\n\r\n“gdb”, “android_server” 등의 동적 디버깅에 사용되는 도구들의 명령어 및 메모리상의 관련 문자열 확인을 통해서 디버깅 여부를 확인합니다.\r\n\r\n​\t\t\t\t\t\t\t\t\t ![](https://t1.daumcdn.net/cfile/tistory/99F03F3F5BF4F19017)\r\n\r\n![](https://t1.daumcdn.net/cfile/tistory/995AFF375BF4F19016)\r\n\r\n​\t\t\t\t\t\t[그림 7] 명령어 및 메모리 확인을 통한 안티 디버깅\r\n\r\n  \r\n\r\n3.5 시간 확인\r\n\r\n코드 실행 중간중간에 시간 관련 함수를 추가하여 해당 코드의 실행 시간을 계산하여 디버깅 여부를 확인합니다.\r\n\r\n![](https://t1.daumcdn.net/cfile/tistory/99717B395BF4F19018)\r\n\r\n​\t\t\t\t\t\t\t\t[그림 8] 시간 확인을 통한 안티 디버깅\r\n\r\n  \r\n\r\n3.6 덱스 파일 덤프\r\n\r\n안티 디버깅을 모두 우회하면 복호화된 덱스 파일은 “libart.so” 모듈에 의해서 메모리로 로드되는데, 이때 덱스 파일이 로드된 메모리 주소와 덱스 파일 구조에 기록되어 있는 덱스 파일의 크기를 계산하여 해당 부분을 덤프합니다. 다음 실제 코드가 담긴 덱스코드를 분석합니다.\r\n\r\n![](https://t1.daumcdn.net/cfile/tistory/993EA33C5BF4F1900D)\r\n\r\n![](https://t1.daumcdn.net/cfile/tistory/99AAB34D5BF4F1901B)\r\n\r\n![](https://t1.daumcdn.net/cfile/tistory/9959773D5BF4F1902B)\r\n\r\n​\t\t\t\t\t\t\t\t\t[그림 9] 덱스 파일 덤프\r\n\r\n  \r\n\r\n\\4. 덱스 파일 분석\r\n\r\n  \r\n\r\n“assets” 폴더에는 “image.zip” 파일이 있는데 내부에는 악성 행위에 사용되는 가짜 통화 관련 사진과 악성 앱을 구성하는 여러 개의 사진 등이 있습니다.\r\n\r\n​\t\t  ![](https://t1.daumcdn.net/cfile/tistory/999955365BF4F19019)\r\n\r\n![](https://t1.daumcdn.net/cfile/tistory/99F8D8385BF4F1901B)\r\n\r\n![](https://t1.daumcdn.net/cfile/tistory/990E2A355BF4F19024)\r\n\r\n​\t\t\t\t\t\t\t\t[그림 10] 악성 앱에 사용되는 파일\r\n\r\n  \r\n\r\n기기의 아이디와 전화번호를 탈취하여 식별 정보로 사용합니다.\r\n\r\n  \r\n\r\n![](https://t1.daumcdn.net/cfile/tistory/99F406385BF4F1911B)\r\n\r\n​\t\t\t\t\t\t\t\t\t[그림 11] 기기 정보 탈취\r\n\r\n  \r\n\r\n기기 부팅 시 서비스를 실행시켜 지속적인 악성 행위를 가능토록 합니다.\r\n\r\n  \r\n\r\n​\t\t\t\t ![](https://t1.daumcdn.net/cfile/tistory/99D8FF4C5BF4F19113)\r\n\r\n​\t\t\t\t\t\t\t\t\t[그림 12] 기기 부팅 시 재실행\r\n\r\n  \r\n\r\n 안드로이드 정책에서는 일정 시간 동안 와이파이를 사용하지 않으면 꺼지게 되는데 이를 방지하여 C&C와의 지속적인 통신을 가능토록 합니다.\r\n\r\n  \r\n\r\n![](https://t1.daumcdn.net/cfile/tistory/991B804B5BF4F19118)\r\n\r\n​\t\t\t\t\t\t\t\t\t[그림 13] 지속적인 와이파이 연결\r\n\r\n  \r\n\r\n메시지를 주기적으로 감시하고 탈취하여 C&C 서버로 전송합니다.\r\n\r\n   \t![](https://t1.daumcdn.net/cfile/tistory/99927A475BF4F19111)\r\n\r\n​\t\t\t\t\t\t\t\t\t\t[그림 14] 메시지 탈취\r\n\r\n\r\n\r\n주소록을 주기적으로 감시하고 탈취하여 C&C 서버로 전송합니다.\r\n\r\n  \r\n\r\n​\t ![](https://t1.daumcdn.net/cfile/tistory/99C36E4F5BF4F19116)\r\n\r\n\r\n\r\n  \t\t\t\t\t\t\t\t\t\t[그림 15] 주소록 탈취\r\n\r\n  \r\n\r\n통화 상태를 확인하고 특정 번호를 감시하여 해커에게 연결되도록 하고 사용자를 속이기 위해서 가짜 통화 사진을 팝업합니다.\r\n\r\n  \r\n\r\n![](https://t1.daumcdn.net/cfile/tistory/99FD6F475BF4F19121)\r\n\r\n​\t\t\t\t\t\t\t\t\t\t[그림 16] 통화 탈취\r\n\r\n\r\n\r\nC&C 서버는 “lib” 폴더의 “libmasker.so” 파일 내부의 함수 호출을 통해서 불러옵니다.\r\n\r\n![](https://t1.daumcdn.net/cfile/tistory/998FD04E5BF4F19119)\r\n\r\n![](https://t1.daumcdn.net/cfile/tistory/99C5823B5BF4F19118)\r\n\r\n​\t\t\t\t\t\t\t\t\t\t[그림 17] C&C 서버\r\n\r\n\r\n\r\n**결론**\r\n\r\n\r\n\r\n해당 악성 앱은 금융권 앱의 아이콘과 이름을 사칭합니다. 사용자의 기기 및 개인정보를 탈취하고 전화 상태를 확인하여 특정번호를 감시합니다. 통화를 종료하고 해커에게 전화를 자동으로 걸도록 하여 금융 정보를 탈취합니다. 특히, 앱의 분석을 어렵게 하기 위해서 중국의 Qihoo 360의 패킹을 적용했습니다.\r\n\r\n\r\n\r\n따라서, 악성 앱으로부터 피해를 최소화하기 위해서는 백신 앱을 통한 주기적인 검사가 중요합니다. 출처가 불명확한 URL과 파일은 실행하지 않는 것이 기본이고 공식 마켓인 구글 플레이스토어를 통해서 확보한 앱이라도 백신 앱을 추가 설치하여 주기적으로 업데이트하고 검사해야 합니다.\r\n\r\n\r\n\r\n현재 알약 M에서는 해당 앱을 **‘Trojan.Android.KRBanker’** 탐지 명으로 진단하고 있습니다.\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n출처 : https://www.estsecurity.com/securityCenter/malwareReport/1?"},"hashtag":["well-done","analyzed","gosu"],"publickey":"5dvW5oJp1uS7pH5iJbQmy2LEz4ZS5YbMZuTYwGPeSynrRQNpgs","permlink":"01653a9df19d553b734547f6c516fed7402536c73214d5e67262ac2e8a16efc622","sign":{"type":"Buffer","data":[17,180,232,139,7,191,225,78,77,30,31,187,241,131,95,175,239,184,236,93,139,22,155,157,143,48,9,18,196,45,90,3,46,108,87,153,239,226,220,66,21,77,116,216,72,103,71,219,188,213,115,201,110,51,246,161,82,8,151,238,121,77,33,50]}},{"title":"report ofTrojan.Ransom.CryptoJoker.md","timestamp":1544300520785,"body":{"black_white":0,"filetype":"exe_32bit","first_seen":"2018-11-10 08:48:48","ai_score":100,"view_count":0,"result_msg":"Data exists","file_info":{},"filename":"","version":"2015072100","filesize":290972,"sha256":"9C64D72DF8C12C8B97274BF05F530C64749503A37DBDEA583B02DE83EFC3EB48","taglist":["user_directory","overlay","ransomware","peexe","exe_32bit","interested_strings_url"],"string":{"pdb":""},"imphash":"E2A592076B17EF8BFB48B7E03965A3FC","distribute_url":[],"date":"2018-11-13 09:04:21","ssdeep":"6144:PpkXGhYZuuoORZvBuuxeQhwbzxF1JstFM/EDU8ZaSc8O4SXwnTQknJxe:iVuuoSZ9xifMF6EDU8ZFRhSgnEkn7e","adversary":{},"md5":"4ABAE1B22466E2759219CA7726D6115D","sha1":"99DE7782184EC05DB20CC8E86BD80620E7F2ED92","signcheck":{"verified":"Unsigned"},"tag_name_etc":[{"tag":"trojan","type":2},{"tag":"agent","type":2},{"tag":"network_dns","type":11},{"tag":"network_http","type":11},{"tag":"network_ssl","type":11},{"tag":"network_smb_cifs","type":11},{"tag":"cerber","type":2},{"tag":"cryptolocker","type":2}],"behavior":{"wxp_32_kor":{"date":"2018-11-10 19:34:45","detection":[{"path":"<MWS_SAMPLE_DIR>\\lkur2g.exe","pid":1792,"description":"Create file in user directory","dflag":2},{"path":"<MWS_SAMPLE_DIR>\\lkur2g.exe","pid":1824,"description":"Create file in user directory","dflag":2},{"path":"<MWS_SAMPLE_DIR>\\lkur2g.exe","pid":1824,"description":"Modify document file","dflag":1},{"path":"c:\\windows\\system32\\mshta.exe","pid":1180,"description":"Create file in user directory","dflag":2},{"path":"c:\\program files\\internet explorer\\iexplore.exe","pid":712,"description":"Create file in user directory","dflag":2},{"path":"c:\\program files\\internet explorer\\iexplore.exe","pid":1420,"description":"Create file in user directory","dflag":2}],"security_level":1}},"similar_to_file":[],"result_code":1,"analyzer":"5dvW5oJp1uS7pH5iJbQmy2LEz4ZS5YbMZuTYwGPeSynrRQNpgs","collector":"5K32TiTRRpEMvSTURMyyRE6pHd8cFKcwqdRBu2B4pQCg1fMaYh","description":"**Trojan.Ransom.CryptoJoker**\r\n\r\n\r\n\r\n최근 CrpytoJoker 랜섬웨어의 변종으로 CryptoNar로 불리는 랜섬웨어가 발견되었습니다. CryptoJoker 랜섬웨어와는 다르게 암호화 대상이나 방법에는 차이점을 보입니다. CryptoNar 랜섬웨어는 암호화 제외 확장자를 따로 구분하지 않아 바탕 화면에 존재하는 모든 폴더와 파일이 암호화 대상이 됩니다. 파일 암호화가 완료되면, 시스템 정보와 RSA키 정보를 공격자 메일로 전송합니다. 현재 복호화 도구가 공개되어 피해를 최소화할 수 있으나, 지속적인 변종이 등장할 가능성이 높은 만큼 사용자의 주의가 필요합니다. \r\n\r\n\r\n\r\n따라서, 본 보고서에서는 CryptoNar 랜섬웨어를 상세 분석하고자 합니다. \r\n\r\n\r\n\r\n\r\n\r\n**악성코드 상세 분석**\r\n\r\n\r\n\r\n\\1. 중복 실행 방지\r\n\r\n중복 실행을 방지하기 위해 특정 폴더 내에 ‘jokingwithyou.cryptoNar’ 파일 유무를 검사합니다. 파일 존재하지 않으면 암호화가 진행되지 않은 시스템으로 인지하고 악성 행위를 계속합니다. \r\n\r\n  \r\n\r\n![](https://t1.daumcdn.net/cfile/tistory/993B7F345B9B972632)\r\n\r\n​\t\t\t\t\t\t\t\t\t[그림 1] 중복 실행 방지 코드\r\n\r\n\r\n\r\n\r\n\r\n\\2. 파일 암호화\r\n\r\nCryptoNar랜섬웨어는 파일을 암호화할 때, 확장자에 따라 암호화 방법이 상이합니다. 파일 확장자가 ‘.txt’, ‘.md’일 경우에는 데이터 전체를 암호화 하고 ‘.fully.cryptoNar’ 확장자를 추가합니다. 그 외 확장자를 가진 파일은 데이터의 첫 1024바이트만 암호화하고 ‘.partially.cryptoNar' 확장자를 추가합니다. \r\n\r\n![](https://t1.daumcdn.net/cfile/tistory/992BE5365B9B972612)\r\n\r\n \t\t\t\t\t\t\t\t\t\t[그림 2] 확장자 구분 코드\r\n\r\n\r\n\r\n기존 CryptoJoker 랜섬웨어와는 다르게 확장자 구분없이 모든 파일을 암호화합니다. 다음은 암호화가 끝난 후 확장자가 추가된 화면입니다. 해당 파일들은 더 이상 정상 파일로 동작하지 않습니다. \r\n\r\n![](https://t1.daumcdn.net/cfile/tistory/998048495B9B972609)\r\n\r\n​\t\t\t\t\t\t\t\t\t[그림 3] 암호화된 파일 화면\r\n\r\n\r\n\r\n2.1파일 암호화 알고리즘\r\n\r\n파일 암호화는 간단한 바이트 덧셈 연산으로 이뤄집니다. 암호화할 원본 데이터와 임의로 생성한 20바이트 문자열 \r\n\r\n(ex: 8V2ZQCT2Q8MGLX5PQEIH)의 첫 1바이트를 더하여 암호화 데이터를 생성합다. 첫 1바이트는 파일 암호화에 사용되는 EncryptionKey로 본 악성코드에서는 0x38(‘8’)가 사용되었습니다. \r\n\r\n\r\n\r\n암호화 데이터 = 원본 데이터 + EncryptionKey [(0x38(‘8’)]\r\n\r\n\r\n\r\n다음과 같이 ‘.partially.cryptoNar’로 암호화된 파일의 데이터가 첫 1024바이트(0x400)까지 암호화된 것을 확인할 수 있습니다. 각 바이트 값들이 덧셈 연산에 의해 0x38씩 증가했습니다.\r\n\r\n![](https://t1.daumcdn.net/cfile/tistory/99BC1C4A5B9B97260B)\r\n\r\n​\t\t\t\t\t\t\t\t\t[그림 4] 부분 암호화된 데이터\r\n\r\n  \r\n\r\n\\3. 랜섬노트 생성\r\n\r\n파일 암호화가 완료되면, 사용자에게 감염 사실과 복호화 방법을 안내하기 위한 랜섬노트가 ‘CRYPTONAR RECOVERY INFORMATION.txt’ 이름으로 바탕화면에 생성됩니다. 공격자는 복호화 키를 구매하기 위해 72시간 이내로 $200의 비트코인을 지불해야 한다고 지시합니다. \r\n\r\n  \r\n\r\n비트코인 주소: 1FeutvrVeiF8Qdnnx9Rr3CyBfHBCFeKWPq\r\n\r\n  \r\n\r\n![](https://t1.daumcdn.net/cfile/tistory/99EB5A4E5B9B972603)\r\n\r\n \t\t\t\t\t[그림 5] CRYPTONAR RECOVERY INFORMATION 랜섬노트\r\n\r\n  \r\n\r\n\\4. SMTP 메일 전송 \r\n\r\n\r\n\r\n또한, 파일 암호화 완료 후SMTP 프로토콜을 이용해 시스템 정보 및 RSA 키 정보를 공격자에게 전달합니다. 메일 전송은 ‘smtp.zoho.eu’ 호스트를 이용합니다. \r\n\r\n![](https://t1.daumcdn.net/cfile/tistory/9954F8485B9B972606)\r\n\r\n[그림 6] SMTP 메일 전송 코드\r\n\r\n\r\n\r\n다음은 메일 전송에 필요한 데이터 형식입니다. 메일 제목은 Hello이며 ‘johnstang@zoho.eu’로부터 ‘johnsmith987654@tutanota.com’으로 전송됩니다. Body 항목에 공격자가 원하는 정보가 저장되어 있다. 이 때, How are you로 전송되는 RSA 키 정보는 추후 드롭되는 ‘CryptoNarDecryptor.exe’ 프로그램에서 복호화 키로 사용됩니다. ‘CryptoNarDecryptor.exe’는 암호화된 파일을 복호화 하는 기능을 가진 프로그램으로 ‘2.5 파일 복호화’ 부분에서 더 자세한 내용을 확인할 수 있습니다.\r\n\r\n\r\n\r\nBody\r\n\r\n\\- Hello: 사용자 식별을 위한 개인 고유 ID \r\n\r\n\\- How are you: Base64로 인코딩 된 RSA 키 (RSA키는 파일 암호화에 사용되지 않습니다.)\r\n\r\n![](https://t1.daumcdn.net/cfile/tistory/994C324C5B9B97260F)\r\n\r\n[그림 7] SMTP 메일 전송 데이터 형식\r\n\r\n\r\n\r\n네트워크 패킷을 통해 메일이 정상적으로 암호화되어 전달된 것을 알 수 있습니다. \r\n\r\n\r\n\r\n220: 도메인 서비스가 준비되었음을 알리는 응답 코드\r\n\r\n250: 요청한 메일을 정상적으로 전달하였음을 알리는 응답 코드\r\n\r\n![](https://t1.daumcdn.net/cfile/tistory/995A3E475B9B972605)\r\n\r\n​\t\t\t\t\t\t\t\t[그림 8] SMTP 메일 네트워크 패킷\r\n\r\n\r\n\r\n\r\n\r\n\\5. 파일 복호화 프로그램\r\n\r\n공격자는 파일 복호화 프로그램으로 ‘CrytoNarDecryptor.exe’ 파일을 바탕화면에 생성 후 실행합니다. 이 파일은 CryptoNar 랜섬웨어 리소스 영역에 저장되어 있습니다. 해당 파일은 다음과 같이 크롬 아이콘을 사용합니다.\r\n\r\n![](https://t1.daumcdn.net/cfile/tistory/990A124F5B9B972614)\r\n\r\n​\t\t\t\t\t\t\t[그림 9] ‘CrytoNarDecryptor.exe’파일 생성\r\n\r\n  \r\n\r\n시스템 재부팅 시에도 자동 실행될 수 있도록 레지스트리(HKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\Run) 에 ‘Sound Card’ 이름으로 키 값을 등록합니다.\r\n\r\n  \r\n\r\n![](https://t1.daumcdn.net/cfile/tistory/99B737365B9B972605)\r\n\r\n​\t\t\t\t\t\t[그림 10] ‘Sound Card’이름으로 자동 실행 등록\r\n\r\n  \r\n\r\n다음은 ‘CrytoNarDecryptor.exe’ 실행 화면입니다. 복호화 방법과 개인 고유 ID, 비트코인 주소를 확인할 수 있고, RSA키 를 적용하여 파일을 복원할 수 있는 기능이 포함되어 있습니다.\r\n\r\n  \r\n\r\n![](https://t1.daumcdn.net/cfile/tistory/991FD53E5B9B972636)\r\n\r\n​\t\t\t\t\t\t\t[그림 11] ‘CrytoNarDecryptor.exe’ 실행 화면\r\n\r\n  \r\n\r\n다음은 복호화 키를 입력할 수 있는 화면입니다. 이 복호화 키는 Base64형태로 인코딩 된 RSA키 이며, 공격자에게 메일로 전송한 키입니다.\r\n\r\n![](https://t1.daumcdn.net/cfile/tistory/99C68A4F5B9B97261A)\r\n\r\n​\t\t\t\t\t\t\t\t\t[그림 12] RSA 키를 입력하는 화면\r\n\r\n  \r\n\r\n다음과 같은 코드를 통해 유효한 RSA 키가 입력되었는지 확인합니다. 만약에 이 RSA 키가 유효한 경우에는 암호화된 파일을 복호화 할 수 있습니다. \r\n\r\n![](https://t1.daumcdn.net/cfile/tistory/99C3C9425B9B972629)\r\n\r\n​\t\t\t\t\t\t\t\t\t\t[그림 13] RSA 키 유효성 검사\r\n\r\n\r\n\r\n다음은 유효한 RSA키가 적용되었을 때 복호화를 시작하는 화면입니다. \r\n\r\n​\t\t\t\t\t\t\t\t\t\t ![](https://t1.daumcdn.net/cfile/tistory/994BEA4C5B9B97260F)\r\n\r\n​\t\t\t\t\t\t\t\t\t[그림 14] 복호화 시작 안내 화면\r\n\r\n \r\n\r\n다음은 파일 복호화 알고리즘이다. 암호화에 사용되었던 EncryptionKey를 빼주면 원본 데이터를 얻을 수 있습니다. \r\n\r\n\r\n\r\n암호화 데이터 = 원본 데이터 - EncryptionKey [0x38(‘8’)]\r\n\r\n\r\n\r\n정상적으로 복원된 파일은 다음과 같습니다. \r\n\r\n![](https://t1.daumcdn.net/cfile/tistory/997E4F505B9B972627)\r\n\r\n​\t\t\t\t\t\t\t[그림 15] 정상적으로 복원된 파일 화면\r\n\r\n  \r\n\r\n  \r\n\r\n**결론**\r\n\r\n\r\n\r\nCrpytoNar 랜섬웨어의 암호화 방법은 다른 랜섬웨어에 비해 비교적 간단한 바이트 덧셈 연산을 이용합니다. 그렇기 때문에 복호화 방법 역시 간단하고, EncryptionKey를 알면 암호화된 모든 파일을 복호화 할 수 있습니다. 이때, 원본 파일을 가지고 있다면 암호화된 파일과 비교를 통해서 EncryptionKey를 쉽게 알아낼 수 있습니다. \r\n\r\n\r\n\r\n마찬가지로, RSA 키를 알고 있는 경우 ‘CryptoNarDecryptor.exe’ 프로그램을 통해서, 공격자에게 비용을 지불하지 않고도 암호화된파일을 복원할 수 있습니다.\r\n\r\n\r\n\r\n또한, 중복 실행 방지를 위해 생성되는 ‘jokingwithyou.cryptoNar’ 파일을 %AppData% 하위에 미리 생성해 두면 CrpytoNar 랜섬웨어에 감염되는 것을 예방할 수 있습니다.  \r\n\r\n\r\n\r\n사용자들은 랜섬웨어를 예방하기 위해 중요 파일은 주기적으로 백업하는 습관을 들여야 합니다. 또한 패치 누락으로 인한 취약점이 발생하지 않도록 운영체제와 소프트웨어는 최신 버전을 유지하는 것이 중요합니다. \r\n\r\n\r\n\r\n현재 알약에서는 **‘Trojan.Ransom.CryptoJoker’**로 진단하고 있습니다. \r\n\r\n\r\n\r\n출처:https://www.estsecurity.com/securityCenter/malwareReport/1?"},"hashtag":["well-done","analyzed","gosu"],"publickey":"5dvW5oJp1uS7pH5iJbQmy2LEz4ZS5YbMZuTYwGPeSynrRQNpgs","permlink":"01a50bf622bd672d49931b6d583fa21840fc9ab4dfec30c74551ca391584150d73","sign":{"type":"Buffer","data":[230,206,61,231,110,197,48,52,232,1,255,41,194,177,199,162,175,30,210,111,149,82,58,96,22,27,208,152,161,141,228,162,86,93,149,96,52,145,222,52,32,72,68,9,194,157,164,165,42,195,35,74,225,198,75,231,30,198,13,177,17,84,89,30]}},{"title":"report ofPOS 시스템을 노린 악성코드.md","timestamp":1544300715120,"body":{"black_white":0,"filetype":"exe_32bit","first_seen":"2018-11-09 12:40:08","ai_score":100,"view_count":0,"result_msg":"Data exists","file_info":{},"filename":"","version":"2015072100","filesize":3514368,"sha256":"8A4A89642A55B6A8BE49F323C4B4A18DB1B5125EF4661AF137C414C6F66546D2","taglist":["peexe","exe_32bit"],"string":{"pdb":""},"imphash":"68F013D7437AA653A8A98A05807AFEB1","distribute_url":[],"date":"2018-11-13 09:12:03","ssdeep":"98304:QqPoBhktcSUDk36SAjvzUs6Q5GksluAQLeFom:QqPftcxk3ZAjXd5r6h","adversary":{},"md5":"6E066BF4D9C2131F5FE2AF690693EDCE","sha1":"4AEDDA2ABF23B1AC34666EBB2D070B0E165D445A","signcheck":{"verified":"Unsigned"},"tag_name_etc":[{"tag":"trojan","type":2},{"tag":"wannacryptor","type":2},{"tag":"ransomware","type":2},{"tag":"wannacry","type":2},{"tag":"wannacrypt","type":2},{"tag":"wanna","type":2},{"tag":"wcry","type":2}],"behavior":{"result":"analyzing"},"similar_to_file":[],"result_code":1,"analyzer":"7hph47f2d6K1Ke5FF5sWBvHiNqUzaxs6mUNRESsarpLynM14nJ","collector":"8GQ5tL2DxbGrR3SLAJL6cmdJF4pd6J9267fSmhmFYWmAmCQCX7","description":"# POS 시스템을 노린 악성코드\r\n\r\n \r\n\r\n## 1. 개요\r\n\r\n최근 판매시점관리시스템(POS)에 악성코드가 감염되어 먹통이 되는 사건이 발생하였다. 6월 29일 한 POS 기업은 ‘윈도우 XP 시스템 연결 끊김 증상 긴급복구 방법 및 권고사항 안내’ 란 제목의 글을 게시했다. 공지 내용은 윈도우 XP 기반의 특정 POS 시스템에서 인터넷 연결이 안 되는 증상이 발생되고 있다는 내용이었다. 해당 증상은 윈도우 XP의 보안취약성을 악용한 TCP/IP 설정 및 윈도우 서비스의 인터넷 연결 관련 항목에 악영향을 주어 인터넷 연결이 끊어지는 증상이 발생되는 것으로 확인됐다고 밝혔다.\r\n\r\n \r\n\r\n이번 블로그에서는 해당 사건에 쓰였던 악성코드 중에서 이전 ‘WannaCryptor Ransomware’ 에서 쓰였던 EternalBlue, Doublepulsar 취약점을 통해 추가 악성코드를 전파하는 악성코드에 대해 알아보고자 한다.\r\n\r\n \r\n\r\n관련 기사 : \r\n\\- <http://www.etnews.com/20180706000307>\r\n\\- <http://www.boannews.com/media/view.asp?idx=71127>\r\n\r\n \r\n\r\n \r\n\r\n \r\n\r\n## 2. 분석 정보\r\n\r\n### 2-1. 실행 흐름\r\n\r\n분석한 악성코드는 SFX-7Zip 으로 생성된 파일로, 실행 시 내부에 존재하는 파일을 특정 경로에 드롭하여 실행한다. 실행되는 각 파일들은 최종적으로 악성코드를 전파하고 추가 악성코드 다운로드를 시도한다.\r\n\r\n \r\n\r\n \r\n\r\n \r\n\r\n## 3. 악성코드 분석\r\n\r\n### 3-1. SFX-7Zip 파일 실행\r\n\r\nSFX-7Zip 파일은 7Zip 압축 파일로 생성되어 실행 시 특정 경로(C:\\Windows\\Microsoft) 에 관련 파일을 드롭 한다. 이후 드롭 된 파일들이 실행되며 각각의 악성동작을 수행한다. SFX-7zip 파일은 동작이 끝난 뒤 자가 삭제 된다.\r\n\r\n \r\n\r\n### 3-2. 전파대상 탐색 및 추가 기능 파일 동작\r\n\r\nSFX-7Zip 파일에서 드롭되어 실행된 파일들은 같은 경로에 드롭된 여러 파일을 유기적으로 동작 시켜준다. 동작되는 파일은 기본 서비스 해제, 이전 실행 악성코드 종료, 방화벽 해제 등의 환경을 조작하는 파일과 전파대상을 탐색하는 파일이 있다.\r\n전파대상을 탐색하는 파일은 현재 감염 PC 가 속한 공인 IP 대역과 사설 IP 대역을 탐색한다. 이때, 대상이 되는 공인 IP 대역은 특정 사이트를 통해 얻어오며, 사설 I P 대역은 route print 명령어를 통해 구한다. 이후 해당 IP 대역에서 특정 포트가 열려있는지 포트 스캐너를 통해 확인한다.\r\n\r\n \r\n\r\n \r\n\r\n![[그림 1] 공인 IP 대역을 대상으로 공격을 시도하는 파일 스크립트](https://t1.daumcdn.net/cfile/tistory/995C1A375B61156115)[그림 1] 공인 IP 대역을 대상으로 공격을 시도하는 파일 스크립트\r\n\r\n \r\n\r\n \r\n\r\n \r\n\r\n![[그림 2] 사설 IP 대역을 대상으로 공격을 시도하는 파일 스크립트](https://t1.daumcdn.net/cfile/tistory/99A67C375B61156211)[그림 2] 사설 IP 대역을 대상으로 공격을 시도하는 파일 스크립트\r\n\r\n \r\n\r\n \r\n\r\n \r\n\r\n### 3-3. Eternalblue, Doublepulsar 전파 파일 동작\r\n\r\n공격 대상 이 정해지면 Eternalblue, Doublepulsar 취약점을 동작시키는 파일을 실행해주며, 해당 파일은 445 포트와 139 포트를 공격하는 파일로 나누어져 있다.\r\n\r\n해당 취약점에 대한 공격이 성공하면 대상 네트워크의 Victim PC 에 백도어 쉘 코드가 설치되고, 설치에 성공한 백도어 쉘 코드로 악성 DLL (추가 악성코드 다운로드)파일을 전파 및 실행하게 된다.\r\n\r\n \r\n\r\n \r\n\r\n \r\n\r\n![[그림 3] Eternalblue 취약점 공격 툴 실행 스크립트 내용 중 일부](https://t1.daumcdn.net/cfile/tistory/9916F6375B6115620B)[그림 3] Eternalblue 취약점 공격 툴 실행 스크립트 내용 중 일부\r\n\r\n \r\n\r\n \r\n\r\n \r\n\r\n### 3-4. Eternalblue, Doublepulsar 취약점을 통해 감염된 PC 의 파일 동작\r\n\r\n취약점을 통해 전파된 파일은 특정 원격지에서 파일을 다운로드 받는 동작을 수행한다.\r\n\r\n앞선 Doublepulsar 와 Eternalblue 취약점에 의해서 전파된 파일은 Victim PC 의 특정 프로세스에 인젝션 되어 동작된다. 아래의 사진은 Eternalblue 에 의해서 감염된 PC 에서 찍은 패킷 내용으로 특정 원격지로 연결을 시도함을 볼 수 있다.\r\n\r\n \r\n\r\n \r\n\r\n \r\n\r\n![[그림 4] 감염된 PC 에서 특정 원격지로 연결 시도](https://t1.daumcdn.net/cfile/tistory/99EF3F3C5B61164918)[그림 4] 감염된 PC 에서 특정 원격지로 연결 시도\r\n\r\n \r\n\r\n \r\n\r\n \r\n\r\n해당 원격지는 현재 연결되지 않으나 해당 URL에 대한 다운로드 기록을 추적한 결과 추가적으로 다운로드 되는 악성코드는 CoinMiner 관련 파일로 추정 된다.\r\n\r\n \r\n\r\n\r\n\r\n \r\n\r\n \r\n\r\n## 4. 결론\r\n\r\nEternalblue 관련 취약점은 이전 WannaCryptor 랜섬웨어 사건에서 크게 이슈된 적이 있었다. 해당 취약점에 대한 보안 업데이트가 이미 오래전에 배포되었음에도 불구하고, 여전히 피해사례가 발생하고 있다. 따라서 사용자는 Microsoft 에서 제공하는 최신의 Windows 보안 업데이트를 진행하고, 이미 지원이 종료된 OS 는 가급적 최신 버전의 OS 로 업그레이드를 하는 것이 좋다.\r\n\r\n\r\n이외에도 사용중인 안티바이러스 제품이 있다면 해당 제품 역시 최신패턴으로 유지하도록 해야 한다.\r\n\r\n\r\n상기 악성코드는 잉카인터넷 안티바이러스 제품 TACHYON Internet Security 5.0 에서 진단 및 치료가 가능하다.\r\n\r\n \r\n\r\n \r\n\r\n \r\n\r\n![[그림 5] TACHYON Internet Security 5.0 진단 및 치료 화면](https://t1.daumcdn.net/cfile/tistory/99E5DA375B6115630E)[그림 5] TACHYON Internet Security 5.0 진단 및 치료 화면\r\n\r\n출처: \r\n\r\nhttp://erteam.nprotect.com/1799?category=324722\r\n\r\n [잉카인터넷 공식 블로그]"},"hashtag":["well-done","analyzed","gosu"],"publickey":"7hph47f2d6K1Ke5FF5sWBvHiNqUzaxs6mUNRESsarpLynM14nJ","permlink":"01406f0196ff3eda9458960267c761f2ed4ec30c987538f38e35d584a3d0e4daec","sign":{"type":"Buffer","data":[17,6,132,49,144,64,1,47,207,185,36,115,92,190,61,103,200,88,187,171,104,115,26,187,123,35,204,26,163,120,48,30,98,161,210,91,230,38,43,253,11,182,121,57,212,233,143,58,15,16,84,26,64,202,112,131,224,199,255,130,167,121,122,177]}},{"title":"report of경고 메시지 없이 실행되는 MS 워드 비디오 삽입 취약점 주의.md","timestamp":1544300837113,"body":{"black_white":0,"filetype":"doc","first_seen":"2018-11-07 09:15:41","ai_score":100,"view_count":0,"result_msg":"Data exists","file_info":{},"filename":"","version":"2015072100","filesize":39424,"sha256":"A93E99E5F31D368352DF9536294F76C0F532A9728DEFED4329B6392060EA42E2","taglist":["obfuscated","doc","interested_strings_path","macros","auto_create","interested_strings_url"],"string":{"pdb":""},"distribute_url":[],"date":"2018-11-13 09:13:46","ssdeep":"384:wAiSZfI/PKRsnAoks4NMaQO+3m+m9J4Hkb60jL47tW/bi:JAPoHsLIwm9J4xUo","adversary":{},"md5":"D0A9F4AD8BFE8076959FC46C7A9A7B7D","sha1":"69A0C69097B92101AB9E20FDF6C20D65EF6C89DC","signcheck":{},"tag_name_etc":[{"tag":"msword","type":2},{"tag":"shankar","type":2},{"tag":"virus","type":2},{"tag":"macro","type":2},{"tag":"marker","type":2}],"behavior":{"w7_32_kor":{"date":"2018-11-07 21:05:39","detection":[],"security_level":3}},"similar_to_file":[],"result_code":1,"analyzer":"7hph47f2d6K1Ke5FF5sWBvHiNqUzaxs6mUNRESsarpLynM14nJ","collector":"6XwZL8HCkFsSKUwdBWWbNaC2v3JbRxKUgRdEjkNTc6hUSANYq1","description":"# 경고 메시지 없이 실행되는 MS 워드 비디오 삽입 취약점 주의\r\n\r\n## 1. 개요\r\n\r\n최근 한 보안회사에서 마이크로소프트 社의 워드 문서에서 제공하는 비디오 삽입 기능을 악용하여 악성코드를 실행하는 취약점을 발견했다. 해당 취약점을 이용한 공격은 악성코드 실행 과정에서 오류 및 경고 메시지를 출력하지 않기 때문에 사용자의 주의가 필요하다. \r\n이번 보고서에서는 MS Office 문서 파일의 비디오 삽입 기능을 악용한 악성 동작에 대해 알아보고자 한다.\r\n\r\n##  \r\n\r\n## 2. 취약점 정보\r\n\r\n### 2-1. 버전 정보\r\n\r\n\r\n\r\n| **영향 받는 버전**                         |\r\n| ------------------------------------------ |\r\n| Microsoft Office 2016Microsoft Office 2013 |\r\n\r\n\r\n\r\n##   \r\n\r\n## 3. 악성 동작 과정\r\n\r\n### 3-1.  개요\r\n\r\n이번 취약점은 공격자가 정상적인 비디오를 삽입한 후 관련된 설정을 마음대로 수정할 수 있다는 점과 워드에서 수정사항의 악성 여부를 확인하지 않는다는 점을 악용하고 있다. 먼저 공격자는 정상 비디오를 삽입한 후, 워드 문서 내부의 비디오 설정과 관련된 XML 파일을 수정하여 악성코드를 삽입한다. 이후 피해자가 수정된 비디오를 클릭하면 어떤 경고 메시지도 없이 악성코드가 실행되는 것을 확인할 수 있다. 이번 보고서에서는 아래와 같이 정상 비디오를 삽입한 문서 파일을 수정하여 가짜 설치 파일을 다운로드하는 테스트 샘플을 만들어보겠다.\r\n\r\n \r\n\r\n![[그림 1] 정상 영상이 삽입된 문서 파일](https://t1.daumcdn.net/cfile/tistory/9913F94E5BE8D07B25)[그림 1] 정상 영상이 삽입된 문서 파일\r\n\r\n \r\n\r\n \r\n\r\n### 3-2.  악성코드 삽입\r\n\r\n 삽입된 비디오와 관련된 설정은 디폴트로 워드 문서 내부 “document.xml” 파일의 “embeddedHTML” 태그에서 확인할 수 있다. 공격자는 기본적으로 설정되어 있는 “iframe” 태그를 임의의 악성 HTML, 자바스크립트 코드로 변조하여 실행시킬 수 있다. 테스트 샘플에서는 “embeddedHtml” 태그를 수정하여 Youtube 아이콘을 출력하면서 가짜 설치 파일을 다운로드하도록 수정하였다.\r\n\r\n \r\n\r\n![[그림 2] 워드 문서 내부 구조](https://t1.daumcdn.net/cfile/tistory/99EEDF4E5BE8D07C27)[그림 2] 워드 문서 내부 구조\r\n\r\n \r\n\r\n \r\n\r\n \r\n\r\n![[그림 3] 변조된 “embeddedHtml” 태그](https://t1.daumcdn.net/cfile/tistory/9954834E5BE8D07C1B)[그림 3] 변조된 “embeddedHtml” 태그\r\n\r\n \r\n\r\n \r\n\r\n### \r\n\r\n### 3-3.  악성 코드 실행\r\n\r\n 피해자가 비디오를 클릭하여 실행하면, 공격자가 심어놓은 악성코드가 아무런 경고 메시지도 없이 작동하는 것을 확인할 수 있다. 기존의 악성 문서는 매크로를 사용하는 경우가 많은데, 워드 디폴트 보안 설정으로 인해 콘텐츠 사용을 허용하지 않는 한 악성 코드가 작동하지 않았다. 반면 이번에 알려진 취약점은 콘텐츠 사용 허가 없이 삽입된 비디오를 실행시키는 것만으로도 작동할 수 있다는 차이점이 있다.\r\n\r\n \r\n\r\n![[그림 4] 가짜 설치 파일 다운로드](https://t1.daumcdn.net/cfile/tistory/9933864E5BE8D07D25)[그림 4] 가짜 설치 파일 다운로드\r\n\r\n \r\n\r\n## \r\n\r\n##  \r\n\r\n##  \r\n\r\n## 4. 결론\r\n\r\n이번에 알아본 취약점은 HTML, 자바스크립트를 활용하여 다양한 악성 행위를 경고 메시지 없이 실행할 수 있다는 위험성이 있다. 하지만 악성 동작을 실행하기 위해서는 반드시 비디오를 실행시켜야 하므로 사용자가 주의를 기울이면 충분히 피할 수 있는 공격이다.\r\n\r\n따라서 출처가 불분명하거나 신뢰할 수 없는 문서 파일을 열람할 때는 문서 콘텐츠 허용 및 비디오 실행에 주의해야 할 것이다.\r\n\r\n \r\n\r\n출처: \r\n\r\nhttp://erteam.nprotect.com/1951?category=324722\r\n\r\n [잉카인터넷 공식 블로그]"},"hashtag":["well-done","analyzed","gosu"],"publickey":"7hph47f2d6K1Ke5FF5sWBvHiNqUzaxs6mUNRESsarpLynM14nJ","permlink":"01a24cdcde15cec8bf8aa707bfc63e42740daf1da500eac23c800c04eb705feae5","sign":{"type":"Buffer","data":[219,237,231,170,100,173,44,137,78,215,113,189,240,134,38,173,12,23,232,189,241,97,6,102,182,81,209,103,218,247,199,87,77,205,21,120,14,65,173,179,11,164,114,129,190,105,47,63,210,163,87,205,14,9,79,220,95,176,37,96,43,162,32,147]}},{"title":"report of과거 리눅스 커널 취약점 활용한 악성파일 유포 주의.md","timestamp":1544300974559,"body":{"black_white":0,"filetype":"elf","first_seen":"2018-11-13 04:52:21","ai_score":45,"view_count":0,"result_msg":"Data exists","file_info":{},"filename":"rbot.x86","version":"2015072100","filesize":26988,"sha256":"AE84CDF0FEC9703391311AEC6124330BBE8F2EE47428AE3C4F003E5D2BBC299A","taglist":["elf","upx","interested_strings_url"],"string":{"pdb":""},"distribute_url":[],"date":"2018-11-13 09:14:24","ssdeep":"768:NmkxbeFjhPgibv7+AXtGtP7DUtLdt2UUP:sXNPgy7+AiktLT2U6","adversary":{},"md5":"6DCD5485211BC2BB3A5BEC842DD4187E","sha1":"09AD6167BDDDD9B8D3FA65F32D4800C0F0C0C331","signcheck":{},"tag_name_etc":[{"tag":"mirai","type":2},{"tag":"linux","type":2}],"behavior":{"result":"analyzing"},"similar_to_file":[],"result_code":1,"analyzer":"7hph47f2d6K1Ke5FF5sWBvHiNqUzaxs6mUNRESsarpLynM14nJ","collector":"6jPbgfYTUK9HS7b4XZyvYdSpT1dcaBd45A8ww19tUBbZDFKzih","description":"# 과거 리눅스 커널 취약점 활용한 악성파일 유포 주의\r\n\r\n## 1. 개요\r\n\r\n최근 리눅스 커널의 취약점을 이용하여 관리자 권한을 탈취하는 Dirty Cow 취약점(CVE-2016-5195)을 사용한 악성 파일이 유포되고 있다. 해당 샘플에 감염될 시 가상화폐 채굴기로 이용될 뿐만 아니라 감염 PC 의 통신 기록을 참고하여 감염 대상을 늘리는 기능이 있기 때문에 주의가 필요하다.\r\n\r\n \r\n\r\n이번 보고서에서는 Dirty Cow 취약점을 이용하는 백도어 프로그램의 악성 동작에 대해 알아보고자 한다.\r\n\r\n##   \r\n\r\n##  \r\n\r\n## 2. 분석 정보\r\n\r\n### 2-1. 파일 정보\r\n\r\n\r\n\r\n| **구분** | **내용**               |\r\n| -------- | ---------------------- |\r\n| 파일명   | [임의의 파일명].sh     |\r\n| 파일크기 | 31,007 byte            |\r\n| 진단명   | Trojan/Linux.CoinMiner |\r\n| 악성동작 | 파일 암호화            |\r\n\r\n\r\n\r\n\r\n \r\n\r\n### 2-2. 유포 경로\r\n\r\n해당 프로그램은 SSH 통신을 이용한 감염 기능을 포함하고 있으며, 이에 따라 SSH 통신을 통해 유포되고 있을 것으로 추측된다.\r\n\r\n###   \r\n\r\n### 2-3. 실행 과정\r\n\r\n악성 셸 스크립트를 실행하면 가장 먼저 감염 PC 의 시스템 정보를 읽어 감염 동작에 필요한 파일 다운로드 및 설치를 진행한다. 이후 기존에 실행 중인 가상 화폐 채굴기를 제거 하고 새로운 악성 채굴기 설치를 진행하며, 악성 스크립트가 관리자 권한으로 실행되지 않았을 경우엔 Dirty Cow 취약점을 이용하여 관리자 탈취를 시도한다. 관리자 권한으로 실행될 경우 실행 중인 백신 프로세스를 종료시키고, 백도어를 설치 하여 사용자가 악성 동작을 탐지하기 어렵게 만든다. \r\n모든 행위를 마친 후에는 “known_hosts”, “.bash_history” 파일을 참조하여 과거 SSH 통신에 사용된 정보를 추출하고, 해당 주소로 SSH 통신을 시도하여 위의 감염 동작을 재개한다.\r\n\r\n##   \r\n\r\n## 3. 악성 동작\r\n\r\n  \r\n\r\n### 3-1. 기존 가상 화폐 채굴기 제거 및 악성 채굴기 설치\r\n\r\n해당 샘플은 자신이 실행시킨 악성 채굴 프로세스를 제외한 프로세스의 cmdline 을 확인한 후, [표 1]에 속한 문자열이 있으면 가상 화폐 채굴 프로세스로 판단하여 종료시킨다. 이후 다운받은 악성 가상 화폐 채굴 프로그램을 실행하여 공격자의 지갑 주소로 설정된 채굴 작업을 진행한다.\r\n\r\n  \r\n\r\n| **구분**            | **내용**                                                     |\r\n| ------------------- | ------------------------------------------------------------ |\r\n| cmdline 탐지 문자열 | \"stratum+tcp\", \"xmr.crypto-pool.fr\", \"dwarfpool.com\", \"bi-chi.com\", \"ppxxmr.com\", \"cryptonight\", \"supportxmr.com\", \"minexmr.com\" |\r\n\r\n​\t\t\t\t\t\t\t\t[표 1] cmdline 탐지 문자열 목록\r\n\r\n  \r\n\r\n악성 프로그램이 관리자 권한으로 실행될 시 백도어 기능을 수행할 추가 파일을 다운로드한다. 먼저 시스템 OS를 확인하여 OS에 따른 백도어 데몬을 설치하고, 악성 프로세스에 사용되는 Port, 파일, 등이 감지되지 않도록 설정하여 탐지 행위를 방해한다.\r\n\r\n  \r\n\r\n| **구분** | **내용**                                         |\r\n| -------- | ------------------------------------------------ |\r\n| OS명     | “CentOS”, “RedHat”, “Ubuntu”, “Debian”, “Fedora” |\r\n\r\n  \r\n\r\n[표 2] 백도어 설치 대상 OS 목록\r\n\r\n \r\n\r\n \r\n\r\n###  \r\n\r\n### 3-3. 백신 프로세스 종료 및 삭제\r\n\r\n 관리자 권한으로 실행될 시 “/etc/init.d” 디렉터리를 확인하여 [표 3]에 속하는 파일이 존재할 경우, 관련 프로세스 및 파일을 제거한다. \r\n\r\n \r\n\r\n \r\n\r\n\r\n\r\n\r\n\r\n| **구분**        | **내용**                                                     |\r\n| --------------- | ------------------------------------------------------------ |\r\n| 백신 프로세스명 | \"safedog\", \"aegis\", \"yunsuo\", \"clamd\", \"avast\", \"avgd\", \"cmdavd\", \"cmdmgd\", \"drweb-configd\", \"drweb-spider-kmod\", \"esets\", \"xmirrord\" |\r\n\r\n\r\n\r\n[표 3] 종료 백신 프로세스 목록\r\n\r\n \r\n\r\n \r\n\r\n###  \r\n\r\n### 3-4.  SSH 통신 기록을 이용한 감염\r\n\r\n마지막으로, SSH 통신 관련 정보를 기록하는 “known_hosts” 파일과 bash 셸 명령어 내역을 기록한 “.bash_history” 파일을 참조하여 과거 SSH 통신에 사용된 정보를 추출하여 목록화한다. 이후 해당 정보를 이용하여 SSH 통신을 시도하며, 성공 시 위의 감염 동작을 반복하여 감염 PC를 늘린다. \r\n\r\n \r\n\r\n![[그림 1] SSH 통신 기록 정보 추출](https://t1.daumcdn.net/cfile/tistory/99A77A4C5C04CEAD0F)[그림 1] SSH 통신 기록 정보 추출\r\n\r\n\r\n\r\n \r\n\r\n##  \r\n\r\n##  \r\n\r\n##  \r\n\r\n## 4. 결론\r\n\r\nDirty Cow 취약점은 시스템 관리자 권한을 빼앗는다는 강력한 메리트 때문에 첫 등장 이후로도 이를 응용한 새로운 취약점이 발견되는 등, 빈번하게 사용되어왔다. 앞서 보았듯이 감염된 PC는 자기 시스템만 조종당할 뿐만 아니라 신뢰 관계를 맺고 있는 다른 PC까지 감염시킬 수 있기 때문에, 이를 방지하기 위해서라도 지속적인 최신 OS 업데이트가 필요하다.\r\n\r\n \r\n\r\n상기 악성코드는 잉카인터넷 안티바이러스 제품 TACHYON Internet Security 5.0에서 진단 및 치료가 가능하다.\r\n\r\n \r\n\r\n![[그림 2] TACHYON Internet Security 5.0 진단 및 치료 화면](https://t1.daumcdn.net/cfile/tistory/998B47415C04CC9112)[그림 2] TACHYON Internet Security 5.0 진단 및 치료 화면\r\n\r\n출처: \r\n\r\nhttp://erteam.nprotect.com/1984?category=324722\r\n\r\n [잉카인터넷 공식 블로그]"},"hashtag":["well-done","analyzed","gosu"],"publickey":"7hph47f2d6K1Ke5FF5sWBvHiNqUzaxs6mUNRESsarpLynM14nJ","permlink":"01d9ac4755bda7267e281142cb58c2b83f3bd5cf9635fdc5aa752fe8a60496a6a9","sign":{"type":"Buffer","data":[61,99,72,154,245,99,12,226,122,254,141,252,220,132,225,113,205,161,126,75,182,132,132,68,252,125,219,217,203,42,158,209,10,252,55,177,19,79,136,34,253,196,114,209,161,224,73,57,237,172,45,230,85,121,162,170,212,214,108,74,134,162,3,120]}},{"title":"report of사용자 PC 정보를 탈취하는 악성코드 감염 주의.md","timestamp":1544301061884,"body":{"black_white":0,"filetype":"exe_32bit","first_seen":"2018-11-11 20:36:23","ai_score":100,"view_count":0,"result_msg":"Data exists","file_info":{"product_version":"1.0.0.0","original_filename":"NoFile.exe","file_version":"1.0.0.0","legal_copyright":"","company_name":"","internal_name":"NoFile.exe","product_name":"","file_description":""},"filename":"VOR.EXE","version":"2015072100","filesize":1672192,"sha256":"7D532B72AA153B2E173F05B33476D0EF3B2363894FCD7323931CEFD225DB010B","taglist":["assembly","interested_strings_ip","interested_strings_url","exe_32bit","user_directory","peexe"],"string":{"pdb":""},"imphash":"F34D5F2D4577ED6D9CEEC516C1F5A744","distribute_url":[],"date":"2018-11-13 08:52:16","ssdeep":"6144:Jt1tIDUm74p/6PqDiQ2WqY2vE/k/1tCIV6b8z089T9MOMl3zD58pkZXbueJpJS+L:TUDUGSc/1pT9OBza6lS+cY","adversary":{},"md5":"475A4455948E72302590B8ED59C76171","sha1":"DA7BD65F1923D7F491994A2BF44B882CBFA296C8","signcheck":{"verified":"Unsigned"},"tag_name_etc":[{"tag":"trojan","type":2},{"tag":"ursu","type":2},{"tag":"agent","type":2},{"tag":"msil","type":2},{"tag":"coinstealer","type":2}],"behavior":{"w7_32_kor":{"date":"2018-11-12 08:39:41","detection":[{"path":"<MWS_SAMPLE_DIR>\\fuge3x.exe","pid":2332,"description":"Create file in user directory","dflag":2}],"security_level":2}},"similar_to_file":[],"result_code":1,"analyzer":"7hph47f2d6K1Ke5FF5sWBvHiNqUzaxs6mUNRESsarpLynM14nJ","collector":"6Y1xTb6eySV9T8dFNLy7BYD2fhXLQnUbLJxZ7hhhHw42VXh4CK","description":"# 사용자 PC 정보를 탈취하는 악성코드 감염 주의\r\n\r\n## 1. 개요\r\n\r\n본 보고서에서 다루게 될 내용은 사진 파일 아이콘(.JPEG 형태)을 사용하여 위장한 정보탈취형 악성코드에 대한 내용이다.\r\n대부분의 PC 사용자들이 확장자 보다는 아이콘을 보고 파일을 실행하는데, 이 점을 노려서 이와 같은 형식으로 유포하고 있는 것으로 보인다.\r\n\r\n위장 된 악성코드를 사진 파일로 착각하여 실행 할 경우 감염된 PC 정보 탈취 뿐만 아니라 공격자에게 전달받은 명령을 통해서 추가적인 악성동작을 수행하게 되는데, 각각의 추가 기능에 특정 캐릭터 이름을 붙여놓아 변칙적으로 수행하는 점을 통해서 이전에 해외에 등장했던 악성코드의 변종으로 추정된다.\r\n\r\n악성코드가 가지고 있는 기능중에는 추가 악성파일을 다운받아 실행하는 기능이 포함되어 있어 2차 악성동작이 발생하지 않도록 각별한 주의가 요구 된다.\r\n\r\n \r\n\r\n이번 보고서에서는 사용자의 PC 정보를 탈취하는 악성코드에 대해서 알아보고자 한다.\r\n\r\n \r\n\r\n## 2. 분석 정보\r\n\r\n### 2-1. 파일 정보\r\n\r\n\r\n\r\n\r\n\r\n| **구분** | **내용**                       |\r\n| -------- | ------------------------------ |\r\n| 파일명   | [임의의 파일명].exe            |\r\n| 파일크기 | 1,591,296 bytes                |\r\n| 진단명   | Trojan/W32.InfoStealer.1591296 |\r\n| 악성동작 | 사용자 PC 정보 탈취            |\r\n\r\n\r\n\r\n \r\n\r\n###  2-2. 유포 경로\r\n\r\n해당 악성코드의 정확한 유포경로는 밝혀지지 않았으나, 이메일을 통해 유포되었을 것으로 추정된다.\r\n\r\n \r\n\r\n \r\n\r\n###  2-3. 실행 과정\r\n\r\n해당 '[임의의 파일명].exe' 파일은 'JPEG' 아이콘으로 위장하였으며 해당 파일 실행시 실제 사진파일을 드롭하여 실행한다. 이를 통해 사진파일로 위장하여 유포되었을 것으로 추정되며 실제 그림파일로 사용자의 주의를 돌린 후 화면 뒤에서는 사용자 PC 정보를 수집하여 공격자의 서버로 전송한다.\r\n이후 해당 악성코드는 공격자 서버로부터 명령을 받아 추가적인 악성동작들을 수행하게 된다. \r\n(현재 분석시점에서는 도메인과 통신은 가능하지만 명령어는 남아있지 않다.)\r\n \r\n\r\n \r\n\r\n![[그림 1] JPEG 아이콘 위장](https://t1.daumcdn.net/cfile/tistory/99B048395B9F5AF020)[그림 1] JPEG 아이콘 위장\r\n\r\n \r\n\r\n \r\n\r\n \r\n\r\n \r\n\r\n \r\n\r\n![[그림 2] 실제 드롭하여 실행하는 사진파일](https://t1.daumcdn.net/cfile/tistory/99D2EA395B9F5AF136)[그림 2] 실제 드롭하여 실행하는 사진파일\r\n\r\n \r\n\r\n \r\n\r\n \r\n\r\n \r\n\r\n \r\n\r\n## 3. 악성 동작\r\n\r\n### 3-1. 특정 경로에 자가 복제\r\n\r\n해당 악성코드는 실행시 '%Temp%' 경로 하위에 'PhoneProvidersHandler' 폴더를 생성하여 자신의 자가복제본을 드롭한다.\r\n\r\n \r\n\r\n \r\n\r\n![[그림 3] 특정 경로에 드롭되는 자가복제 파일](https://t1.daumcdn.net/cfile/tistory/99AFE7395B9F5AF121)[그림 3] 특정 경로에 드롭되는 자가복제 파일\r\n\r\n \r\n\r\n \r\n\r\n \r\n\r\n \r\n\r\n \r\n\r\n### 3-2. 사용자 PC 정보 전송\r\n\r\n자가 복제 및 정상 사진파일을 보여준 후, 악성코드는 일정 대기시간이 지나면 공격자의 서버로 수집한 사용자 PC 정보를 포함하여 패킷을 전송한다. 수집하는 정보로는 컴퓨터 이름과 함께 현재 사용중인 'Anti-Virus' 제품을 검색하여 전송한다.\r\n\r\n \r\n\r\n \r\n\r\n![[그림 4] 사용자 PC 정보 전송](https://t1.daumcdn.net/cfile/tistory/9999ED395B9F5AF20C)[그림 4] 사용자 PC 정보 전송\r\n\r\n### \r\n\r\n###  \r\n\r\n###  \r\n\r\n### 3-3. 추가 악성동작 수행\r\n\r\n사용자 정보를 전송하고 응답으로 전달받은 명령어를 통해서 수행하고자 하는 동작을 결정한다. 추가적으로 수행될 수 있는 동작들에는 시스템 재부팅, 추가 악성파일 다운로드 및 실행, 사용자 PC 의 스크린샷 전송 등의 기능을 가지고 있다.\r\n\r\n \r\n\r\n \r\n\r\n![[그림 5] 시스템 재부팅 코드](https://t1.daumcdn.net/cfile/tistory/99D952395B9F5AF206)[그림 5] 시스템 재부팅 코드\r\n\r\n \r\n\r\n \r\n\r\n![[그림 6] 추가 악성파일 다운 및 실행 코드](https://t1.daumcdn.net/cfile/tistory/991E92395B9F5AF215)[그림 6] 추가 악성파일 다운 및 실행 코드\r\n\r\n \r\n\r\n \r\n\r\n \r\n\r\n![[그림 7] 사용자 PC 화면 캡쳐 및 전송 코드](https://t1.daumcdn.net/cfile/tistory/99D824395B9F5AF31D)[그림 7] 사용자 PC 화면 캡쳐 및 전송 코드\r\n\r\n \r\n\r\n \r\n\r\n \r\n\r\n \r\n\r\n \r\n\r\n## 4. 결론\r\n\r\n이번 보고서에서 알아본 악성코드는 감염 시 사용자 PC 정보를 탈취하거나 제어하는 것을 목적으로 두고 있다.\r\n이러한 종류의 악성코드는 일반적으로 수집한 정보를 토대로하여 추가적인 공격에 사용되는 경우가 많으며, 이에 대한 2차 피해가 발생하지 않도록 주의를 기울여야 한다.\r\n\r\n감염에 의한 피해를 최소한으로 막기 위해서 사용하고 있는 보안 제품이나 OS를 항상 최신 버전으로 유지하여야 하며, 신뢰할 수 없는 사이트에서 다운받은 파일을 실행할때에 주의를 기울여야 한다.\r\n\r\n \r\n\r\n상기 악성코드는 잉카인터넷 안티바이러스 제품 TACHYON Internet Security 5.0 에서 진단 및 치료가 가능하다.\r\n \r\n\r\n \r\n\r\n![[그림 8] TACHYON Internet Security 5.0 진단 및 치료 화면](https://t1.daumcdn.net/cfile/tistory/99B9FF395B9F5AF309)[그림 8] TACHYON Internet Security 5.0 진단 및 치료 화면\r\n\r\n\r\n\r\n출처: \r\n\r\nhttp://erteam.nprotect.com/1868?category=324722\r\n\r\n [잉카인터넷 공식 블로그]"},"hashtag":["well-done","analyzed","gosu"],"publickey":"7hph47f2d6K1Ke5FF5sWBvHiNqUzaxs6mUNRESsarpLynM14nJ","permlink":"01cbe057637388e2d749772e95a2adf020afb0f0e8be320cfb73c907d4e438db54","sign":{"type":"Buffer","data":[188,18,205,32,221,255,158,247,92,198,14,131,79,136,68,136,136,47,21,197,16,27,209,122,229,33,193,184,7,54,226,19,69,22,156,90,194,243,163,119,91,51,174,71,246,115,98,100,193,49,19,148,247,34,252,95,142,43,154,102,54,250,209,63]}},{"title":"report of음란물 사이트를 통해 유포하는 협박성 악성코드 감염 주의.md","timestamp":1544301117275,"body":{"black_white":0,"filetype":"apk","first_seen":"2018-11-13 05:27:33","ai_score":99,"view_count":0,"result_msg":"Data exists","file_info":{},"filename":"","version":"2015072100","filesize":2409088,"sha256":"656F7C0BEF4A8FD1816FB93646C2FCE509CC9855866C2C1C9F82751E3C9878A2","taglist":["apk","android","interested_strings_url"],"string":{"pdb":""},"distribute_url":[],"date":"2018-11-13 09:08:02","ssdeep":"49152:6Sjn4prsIIGepQPjQ4Mcy/9aFM6J6kNl6ddSVlSsJK32A3judYWWnL5W7a:Z4lsIIGMQw/sFMw6kNkbcSiKmAz6Ynke","adversary":{},"md5":"A51F35B09BC917F5298E472BA0C2A483","sha1":"A38453252C9DA44371FEFFC2082045DECFE0B024","signcheck":{},"tag_name_etc":[{"tag":"pornvideo","type":2},{"tag":"riskware","type":2},{"tag":"smsreg","type":2},{"tag":"androidos","type":2},{"tag":"mobilepay","type":2}],"behavior":{"result":"analyzing"},"similar_to_file":[],"result_code":1,"analyzer":"7hph47f2d6K1Ke5FF5sWBvHiNqUzaxs6mUNRESsarpLynM14nJ","collector":"6XwZL8HCkFsSKUwdBWWbNaC2v3JbRxKUgRdEjkNTc6hUSANYq1","description":"# 음란물 사이트를 통해 유포하는 협박성 악성코드 감염 주의\r\n\r\n\r\n\r\n## 1. 개요 \r\n\r\n\r\n\r\n해외 음란물 사이트를 통해 유포된 이번 악성코드는 아동 음란물 다운로드 및 유포 행위에 대한 신고를 빌미로 사용자에게가상화폐를 요구한다. 감염 시스템상의 피해를 주진 않지만 금전 갈취를 목적으로 사용자PC에서 수집한 정보를 공개하고 있어 주의를 기울여야 한다. \r\n\r\n이번 보고서에는 가상화폐를 요구하는 협박성 악성코드에 대해서 알아보고자 한다.\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n## 2. 분석 정보\r\n\r\n\r\n\r\n### 2-1. 파일 정보\r\n\r\n| **구분**     | **내용**                          |\r\n| ------------ | --------------------------------- |\r\n| **파일명**   | [임의의 파일명].exe               |\r\n| **파일크기** | 616,448 byte                      |\r\n| **진단명**   | Trojan/W32.PornBlackMailer.616448 |\r\n| **악성동작** | 가상화폐 요구 협박                |\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n### 2-2. 유포 경로\r\n\r\n### \r\n\r\n### \r\n\r\n### \r\n\r\n### \r\n\r\n해외 음란물 사이트를 통해 유포한다.\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n### 2-3. 실행 과정\r\n\r\n### \r\n\r\n### \r\n\r\n### \r\n\r\n### \r\n\r\n악성코드를 실행하면 자기 자신을 ‘%appdata%’ 경로에 ‘temps.exe’ 라는 이름으로 복사하여 실행시킨다. 실행된 ‘temps.exe’ 는 사용자의 화면을 캡처하고 위치정보나 PC정보를 수집한다. 이후 바탕화면 경로에 ‘READ_ME.txt’ 파일을 생성한다.\r\n\r\n\r\n\r\n아래 그림은 ‘READ_ME.txt’ 파일의 내용으로 요약하면 “당신은 아동 음란물을 보고 유포하였으며 가상화폐 0.01 코인을 24시간 내에 보내지 않으면 당신의 PC정보가 자동으로 경찰에 발송되어 처벌받게 될 것이다.” 라며 입금할 가상화폐 지갑주소를 안내하고 있다.\r\n\r\n\r\n\r\n![[그림 1] READ_ME.TXT 내용](https://t1.daumcdn.net/cfile/tistory/99CAAE365A80FCDF0B)[그림 1] READ_ME.TXT 내용\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n## 3. 악성 동작\r\n\r\n###  \r\n\r\n### 3-1. 사용자 화면 캡쳐\r\n\r\n실제 사용자의 PC정보가 탈취되었다는 것을 감염자에게 확신시키기 위해 악성코드가 수집한 정보를 특정 경로에 저장하고사용자가 탈취된 정보를 확인할 수 있도록 ‘READ_ME.txt’ 파일 내용에 경로를 공개한다. 아래 그림은 사용자의 화면을  캡처하고 ‘%appdata%\\Robin\\server_logs\\desktop_screens’ 경로에 파일로 저장한 모습이다.\r\n\r\n\r\n\r\n![[그림 2] 사용자 화면 저장](https://t1.daumcdn.net/cfile/tistory/9985F9355A80FD131A)[그림 2] 사용자 화면 저장\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n### 3-2. 사용자 정보 수집\r\n\r\n위 내용과 같은 일환으로 PC정보가 탈취되었음을 사용자에게 확신시키기 위해 ‘%UserProfile%\\AppData\\Roaming\\’  경로에 감염자의 IP, 위치, ISP, OS, CPU 정보 등을 ‘your_infomation.txt’ 파일에 저장하고 ‘READ_ME.txt’ 파일에 저장  경로를 공지하고 있다.\r\n\r\n\r\n\r\n![[그림 3] 사용자 화면 저장](https://t1.daumcdn.net/cfile/tistory/992B643B5A80FD4828)[그림 3] 사용자 화면 저장\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n### 3-3. 브라우저 쿠키 및 히스토리 정보 수집\r\n\r\n\r\n\r\n뿐만 아니라 아래 그림과 같이 웹 브라우저의 쿠키와 히스토리 정보를 수집하는 것을 확인할 수 있다.\r\n\r\n\r\n\r\n![[그림 4] 브라우저 쿠키 수집](https://t1.daumcdn.net/cfile/tistory/993E543F5A80FD9121)[그림 4] 브라우저 쿠키 수집\r\n\r\n\r\n\r\n![[그림 5] 브라우저 히스토리 수집](https://t1.daumcdn.net/cfile/tistory/994CE53E5A80FDA834)[그림 5] 브라우저 히스토리 수집\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n### 3-4. 배경화면 변경\r\n\r\n\r\n\r\n아래와 같이 배경화면을 사용자의 IP 정보가 기입된 그림으로 변경하여 ‘READ_ME.txt’ 파일을 열람하도록 유도한다. ‘READ_ME.txt’ 파일 내용에는 가상화폐의 지갑주소가 공지되고 지갑주소는 아래 [표 1]과 같다.\r\n\r\n\r\n\r\n![[그림 6] 바탕화면 변경에 사용되는 그림](https://t1.daumcdn.net/cfile/tistory/99EB3A465A80FDD624)[그림 6] 바탕화면 변경에 사용되는 그림\r\n\r\n\r\n\r\n\r\n\r\n \r\n\r\n| 구분               | 내용                                                         |\r\n| ------------------ | ------------------------------------------------------------ |\r\n| 가상화폐 지갑 주소 | 1Nzieh*******************1CKpj2r*******************18AfNuXM*******************1CzrDKSSC*******************12nkyXjw*******************1GVTebsP*******************1P8VNkE******************* |\r\n\r\n[표 1] 가상화폐 지갑 주소\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n## 4. 결론\r\n\r\n음란물 다운로드를 통해 유포되는 이번 악성코드는 아동 음란물 다운로드 및 유포 행위에 대한 신고를 빌미로 가상화폐를 요구한다. 파일을 암호화하거나 시스템 자체에 해를 끼치진 않지만 사용자 정보를 탈취하여 금전을 요구하는 협박성 악성코드가 PC나 모바일을 통해 종종 발견되어 사용자의 각별한 주의가 필요하다. \r\n\r\n\r\n\r\n이러한 피해를 최소화하기 위해 용도에 맞지 않는 확장자 파일은 실행 전 악성파일이 아닌지 의심해 봐야 한다. 또한 백신 제품을 설치하고 웹 브라우저를 항상 최신 버전으로 업데이트 하는 것을 권고한다.\r\n\r\n\r\n\r\n상기 악성코드는 잉카인터넷 안티바이러스 제품 nProtect Anti-Virus/Spyware V4.0에서 진단 및 치료가 가능하다.\r\n\r\n\r\n\r\n![[그림 5] nProtect Anti-Virus/Spyware V4.0 진단 및 치료 화면](https://t1.daumcdn.net/cfile/tistory/9932AD4F5A80FE0D23)[그림 5] nProtect Anti-Virus/Spyware V4.0 진단 및 치료 화면\r\n\r\n\r\n\r\n출처: \r\n\r\nhttp://erteam.nprotect.com/1543?category=324722\r\n\r\n [잉카인터넷 공식 블로그]"},"hashtag":["well-done","analyzed","gosu"],"publickey":"7hph47f2d6K1Ke5FF5sWBvHiNqUzaxs6mUNRESsarpLynM14nJ","permlink":"015742c88d4801d8bc4c8b0a8111e20c40853316a64ad345e71b033072992c0009","sign":{"type":"Buffer","data":[235,167,92,33,32,153,80,156,90,237,205,24,66,38,67,95,86,112,83,113,178,52,80,1,7,222,179,57,154,217,74,84,46,98,190,25,248,158,28,60,217,136,228,108,233,235,35,177,239,138,88,143,147,71,1,88,28,167,53,24,48,77,94,212]}},{"title":"report of한글 문서에 포함된 매크로 악성코드 분석.md","timestamp":1544301195993,"body":{"black_white":0,"filetype":"hwp","first_seen":"2018-11-13 04:14:28","ai_score":1,"view_count":0,"result_msg":"Data exists","file_info":{},"filename":"","version":"2015072100","filesize":203264,"sha256":"C538341786F20BF6E2F35BD8FDAB6D6304C175B8ECA19A9091E5E7DD69CAF884","taglist":["with_urls","hwp"],"string":{"pdb":""},"distribute_url":["http://file.elis.go.kr/newlaib/laibLaws/h1126/fileDown.jsp%3fsubPath%3d41270/h112603/%26fileName%3d%ba%b0%c7%a5.hwp%26saveFile%3d%ba%b0%c7%a5%28%b1%b8%bb%e7%b9%ab%20%c0%fc%b0%e1%c3%b3%b8%ae%20%b1%d4%c1%a4%29_lga_lgalaw_6LyQGujcDnFpihIS_20171012113714506_1.hwp"],"date":"2018-11-13 09:22:01","ssdeep":"6144:s5ZIRSp+d6GeZWEWQOpBDMHAA5ZSR6p+d6GeZWEWQOpBDMHAn:91d6tEr4gfZd6tEr4gn","adversary":{},"md5":"96B37AF43533BD83BD97C8C9BBC8DA5D","sha1":"1ABEA9D91C8FA7D56EEF116D81C875B973D29E9E","signcheck":{},"tag_name_etc":[{"tag":"network_dns","type":11},{"tag":"network_ntp","type":11}],"behavior":{"w7_32_kor":{"date":"2018-11-13 13:19:17","detection":[],"security_level":3}},"similar_to_file":[],"result_code":1,"analyzer":"7hph47f2d6K1Ke5FF5sWBvHiNqUzaxs6mUNRESsarpLynM14nJ","collector":"5QVKCXDa3WcYeBdzwX4QQmKEeB9cHzvFZgQ5An1hARTMScX8vJ","description":"# 한글 문서에 포함된 매크로 악성코드 분석\r\n\r\n## 1. 개요\r\n\r\n한글 문서의 스크립트 매크로 기능은 사용자가 정의하는 키보드와 마우스 동작을 특정 단축키에 기록하여 매크로로 이용할 수 있는 기능이다. 악성코드 제작자는 이 기능을 악용하여 조작된 HWP 파일을 피싱 메일을 통해 유포하고, 사용자가 조작된 한글 문서를 열람할 때 악성코드가 실행되도록 만든다.\r\n\r\n \r\n\r\n이번 보고서에서는 한글 문서에 포함된 매크로 악성코드에 대해 알아본다.\r\n\r\n##   \r\n\r\n## 2. 한글 문서의 스크립트 매크로 기능\r\n\r\n한글 프로그램에서 사용자가 정의한 매크로는 ‘도구 탭 – 매크로 - 스크립트 매크로 정의’에서 코드 편집이 가능하다.\r\n\r\n \r\n\r\n \r\n\r\n![[그림 1] 스크립트 매크로 코드 창](https://t1.daumcdn.net/cfile/tistory/991FC5395BFDE5560D)[그림 1] 스크립트 매크로 코드 창\r\n\r\n \r\n\r\n \r\n\r\n \r\n\r\n \r\n\r\n \r\n\r\n \r\n\r\nDocument 내용에 코드를 작성하면 한글 문서를 열람할 때 스크립트가 실행된다. 이렇게 매크로 스크립트가 삽입된 한글 문서를 사용자가 열람할 때, 스크립트 매크로 실행 여부를 확인하는 알림 창이 뜬다.\r\n\r\n \r\n\r\n \r\n\r\n![[그림 2] 스크립트 매크로 실행 여부 알림 창](https://t1.daumcdn.net/cfile/tistory/991E2B395BFDE5570D)[그림 2] 스크립트 매크로 실행 여부 알림 창\r\n\r\n \r\n\r\n \r\n\r\n##  \r\n\r\n##  \r\n\r\n## 3. 스크립트 매크로 기능을 악용한 악성 한글 문서\r\n\r\n최근 발견된 스크립트 매크로 기능을 악용해 악성 스크립트를 실행하는 한글 문서의 경우, 해당 악성 한글 문서의 스크립트 코드 창을 확인해보면 파워쉘을 이용해 Base 64로 인코딩된 악성 스크립트를 실행하게 되어있다.\r\n\r\n \r\n\r\n![[그림 3] 악성 코드가 삽입된 스크립트](https://t1.daumcdn.net/cfile/tistory/99798C395BFDE55742)[그림 3] 악성 코드가 삽입된 스크립트\r\n\r\n \r\n\r\n \r\n\r\n \r\n\r\n \r\n\r\n \r\n\r\n \r\n\r\n이때, 파워쉘의 실행 창은 화면에 보이지 않도록 숨김 속성으로 설정되어 실행된다.\r\n\r\n \r\n\r\n \r\n\r\n![[그림 4] PowerShell을 이용한 악성 스크립트 실행](https://t1.daumcdn.net/cfile/tistory/99BAAC395BFDE55804)[그림 4] PowerShell을 이용한 악성 스크립트 실행\r\n\r\n \r\n\r\n### \r\n\r\n\r\n\r\n| **옵션** | **내용**                                                     |\r\n| -------- | ------------------------------------------------------------ |\r\n| -noP     | PowerShell 프로필을 로드하지 않는다.                         |\r\n| -sta     | Powershell 명령을 시스템의 단일 스레드로 시작한다.           |\r\n| -w 1     | Powershell이 백그라운드에서 명령을 실행하고 Powershell 실행창을 숨긴다. |\r\n| -enc     | Base64로 인코딩 된 명령이 해독되어 코드를 실행한다.          |\r\n\r\n[표 1] 커맨드 라인 설명 \r\n\r\n\r\n \r\n\r\n \r\n\r\n \r\n\r\n \r\n\r\n \r\n\r\n \r\n\r\n복호화 된 코드의 내용을 보면, 먼저 파워쉘의 보안 기능을 우회한다. 파워쉘 내에서 실행되는 스크립트를 감사할 수 있는 파워쉘 스크립트 블록 로깅 기능을 비활성화시키고, 악성코드의 탐지를 도와주는AMSI(antimalware scan interface) 기능을 우회한다.\r\n\r\n \r\n\r\n \r\n\r\n![[그림 5] 보안 기능 우회](https://t1.daumcdn.net/cfile/tistory/99B9CC395BFDE55804)[그림 5] 보안 기능 우회\r\n\r\n \r\n\r\n \r\n\r\n \r\n\r\n \r\n\r\n \r\n\r\n \r\n\r\n \r\n\r\n이후 원격지에 접속해서 추가 악성 파일을 다운로드 시도한다. 현재 분석시점에서는 해당 원격지와 연결이 정상적으로 이루어지지 않는다.\r\n\r\n \r\n\r\n \r\n\r\n![[그림 6] 추가 악성코드 다운](https://t1.daumcdn.net/cfile/tistory/998DC8395BFDE5590A)[그림 6] 추가 악성코드 다운\r\n\r\n \r\n\r\n \r\n\r\n \r\n\r\n \r\n\r\n##  \r\n\r\n##  \r\n\r\n## 4. 결론\r\n\r\n이번 보고서에서는 매크로 기능을 악용해 삽입된 악성 스크립트를 실행하는 한글 문서에 대해 알아보았다. 사용자는 출처를 알 수 없거나 의심스러운 스크립트가 포함된 한글 문서를 열람할 때, 스크립트 매크로 실행 여부 확인 창이 뜨면 ‘취소’를 선택하고, 한글 프로그램의 ‘메뉴 탭 – 도구 – 스크립트 매크로 보안 설정’에 들어가서 스크립트 매크로 보안 설정을 ‘매우 높음’ 으로 설정하는 것이 안전하다. 또한 백신 제품을 설치하고 최신 업데이트 버전으로 유지해야 한다.\r\n\r\n \r\n\r\n상기 악성코드는 잉카인터넷 안티바이러스 제품 TACHYON Internet Security 5.0에서 진단 및 치료가 가능하다.\r\n\r\n \r\n\r\n \r\n\r\n![[그림 7] 스크립트 매크로 보안 설정](https://t1.daumcdn.net/cfile/tistory/993F19395BFDE5590C)[그림 7] 스크립트 매크로 보안 설정\r\n\r\n \r\n\r\n \r\n\r\n \r\n\r\n![[그림 8] TACHYON Internet Security 5.0 진단 및 치료 화면](https://t1.daumcdn.net/cfile/tistory/9963F3395BFDE55906)[그림 8] TACHYON Internet Security 5.0 진단 및 치료 화면\r\n\r\n출처: \r\n\r\nhttp://erteam.nprotect.com/1976?category=324722\r\n\r\n [잉카인터넷 공식 블로그]\r\n\r\n"},"hashtag":["well-done","analyzed","gosu"],"publickey":"7hph47f2d6K1Ke5FF5sWBvHiNqUzaxs6mUNRESsarpLynM14nJ","permlink":"01e35e2b72505a6e690d6eb1fd76d4c20653b488702dd9af6c5107fa43d1fd2a45","sign":{"type":"Buffer","data":[14,3,94,191,94,217,35,70,141,153,190,77,111,42,160,231,209,170,36,184,180,74,96,254,173,235,85,145,52,203,230,71,30,72,77,60,79,95,212,120,218,163,189,43,156,136,129,144,164,29,48,47,133,120,121,189,44,113,61,129,209,188,238,199]}}]